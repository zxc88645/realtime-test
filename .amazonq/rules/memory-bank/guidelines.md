# 開發指引

## 程式碼品質標準

### 格式與風格

- **一致縮排**：在所有 JavaScript 檔案中使用 2 個空格縮排
- **分號使用**：始終以分號結束陳述式
- **字串字面量**：優先使用單引號，插值時使用模板字面量
- **行長度**：保持合理的行長度，適當分行複雜表達式
- **尾隨逗號**：在多行物件與陣列字面量中使用尾隨逗號

### 命名約定

- **變數/函數**：使用駝峰式命名（例如：`createRealtimeServer`、`handleConnection`）
- **常數**：模組級常數使用大寫底線命名（例如：`REALTIME_WS_PATH`、`DEFAULT_PORT`）
- **檔案名稱**：JavaScript 檔案使用駝峰式命名（例如：`createExpressApp.js`、`realtimeServer.js`）
- **描述性名稱**：使用清晰、描述性的名稱來表示目的（例如：`buildResponseCreateEvent`、`extractDeltaText`）

### 文件標準

- **中文註解**：所有面向使用者的訊息與主控台記錄都使用中文
- **函數文件**：為複雜函數提供清晰的參數說明
- **錯誤訊息**：為面向使用者的錯誤提供有意義的中文錯誤訊息
- **主控台記錄**：使用描述性的主控台訊息進行除錯與狀態更新

## 架構模式

### 工廠模式實作

```javascript
// 一致的工廠函數結構
function createRealtimeServer(options = {}) {
  const config = buildConfig(options);
  // ... 設定邏輯
  return { app, server, webSocketServer, start };
}
```

### 相依性注入模式

- 以參數形式傳遞相依性，而非直接匯入
- 使用選項物件進行配置（例如：`{ apiKey, realtimeModel, fetchImpl }`）
- 允許模擬實作以啟用測試（例如：`fetchImpl` 參數）

### 事件驅動架構

- 使用 WebSocket 事件處理器進行即時通訊
- 實作適當的事件清理與錯誤處理
- 使用反應式模式進行 UI 狀態管理（Vue.js 組合式 API）

### 錯誤處理模式

```javascript
// 一致的錯誤處理結構
try {
  // 操作
} catch (error) {
  console.error('描述性錯誤訊息', error);
  // 適當的錯誤回應
}
```

## 配置管理

### 環境變數

- 在 `src/config/` 目錄中集中化配置
- 使用 `loadEnvironment()` 初始化環境變數
- 為所有配置值提供合理的預設值
- 在啟動時驗證必需配置（例如 API 金鑰）

### 常數組織

- 在專用檔案中組織相關常數
- 使用表示用途的描述性常數名稱
- 使用物件解構匯出常數以保持清潔的匯入

## API 設計模式

### REST 端點結構

- 使用描述性路徑名稱（例如：`/openai/agents/realtime/ephemeral-token`）
- 實作適當的 HTTP 狀態碼（200、500 等）
- 返回一致的 JSON 回應格式
- 以適當的錯誤訊息優雅地處理缺少的相依性

### WebSocket 通訊

- 在客戶端與上游之間實作雙向訊息代理
- 使用訊息佇列進行連線狀態管理
- 在連線生命週期中向客戶端提供狀態更新
- 在連線關閉時適當清理資源

## 測試標準

### 測試結構

- 使用中文描述性測試名稱來解釋情境
- 使用 `describe` 區塊組織相關測試
- 測試成功與錯誤情境
- 模擬外部相依性（例如 `fetchImpl`）進行獨立測試

### 測試清理

- 在測試清理中始終關閉伺服器與連線
- 優雅地處理伺服器關閉錯誤（檢查 `ERR_SERVER_NOT_RUNNING`）
- 在測試操作中使用適當的 async/await 模式

## 客戶端模式

### 狀態管理

- 使用 Vue.js 反應式物件進行傳輸狀態管理
- 實作計算屬性來處理衝生狀態
- 使用監視器處理副作用與清理
- 為不同傳輸維持獨立的狀態上下文

### 傳輸抽象化

- 為 WebSocket 與 WebRTC 傳輸建立一致的介面
- 實作連線生命週期管理的常用模式
- 使用工廠函數建立傳輸上下文
- 統一處理連線錯誤與清理

### 效能追蹤

- 使用 `performance.now()` 實作延遲測量
- 使用唯一識別符追蹤擱置訊息
- 計算效能指標的運行平均值
- 在連線關閉時清理追蹤資料

## 安全考量

### API 金鑰管理

- 絕不在客戶端程式碼中暴露 API 金鑰
- 在伺服器啟動時驗證 API 金鑰的存在
- 為客戶端 WebRTC 連線使用短效金鑰
- 實作適當的錯誤訊息，不暴露敏感詳細資訊

### 輸入驗證

- 驗證與清理使用者輸入
- 在操作前檢查連線狀態
- 優雅地處理格式錯誤的資料
- 為長時間運行的操作實作適當的逾時機制
